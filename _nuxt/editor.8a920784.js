import{_ as mt}from"./nuxt-link.60028201.js";import{c as W,_ as pt,a as ft,I as vt}from"./Navbar.0f0e4624.js";import{_ as ht}from"./Container.856f971b.js";import{s as w,v as Y,o as _,b as V,e,F as Z,r as tt,u as t,B as p,D as $,E as H,G as et,t as f,f as v,a as gt,L as bt,q as _t,p as xt,m as yt,x as kt,y as wt,i as b,c as N,A as T,O as M,N as X,k as L,R as Dt,C as I,P as U,h as E}from"./entry.b980ff2a.js";import{I as $t}from"./IconX.c873bac0.js";import{_ as It}from"./Dialog.876fc127.js";import{u as Ct}from"./index.b7543822.js";import{c as At}from"./index.browser.bef4f1f3.js";import{I as Vt}from"./IconDatabase.6f9359c4.js";import{I as Bt}from"./IconSquareRoundedPlus.e2c27dfe.js";import{I as Tt}from"./IconMessageCircle.d3b08c7c.js";import{I as Ut}from"./IconPlus.e8cb4070.js";import{I as Et}from"./IconDatabaseExport.8599c1bd.js";import{I as zt}from"./IconTrash.149de794.js";import"./LoadingSvg.54a92436.js";var St=W("alert-circle","IconAlertCircle",[["path",{d:"M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0",key:"svg-0"}],["path",{d:"M12 8v4",key:"svg-1"}],["path",{d:"M12 16h.01",key:"svg-2"}]]),Kt=W("edit","IconEdit",[["path",{d:"M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1",key:"svg-0"}],["path",{d:"M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z",key:"svg-1"}],["path",{d:"M16 5l3 3",key:"svg-2"}]]);const Nt=["for"],Mt={class:"-m-1 inline-block"},Rt={class:"mr-1"},jt=["placeholder","onKeydown","id"],qt={__name:"TagInput",props:{modelValue:{type:Array,required:!0},disabled:{type:Boolean,default:!1},vid:{type:String,default:"tag-input-"+Math.random().toString(36).substr(2,9)}},emits:["update:modelValue"],setup(C,{emit:D}){const u=C,r=w(null),d=w(null),g=w("");d.value=[...u.modelValue||[]],Y(()=>u.modelValue,s=>{d.value=[...s||[]]});function z(s){if(d.value.length!==0){if(s===void 0)if(g.value===""){d.value.pop(),D("update:modelValue",d.value);return}else return;d.value.splice(s,1),D("update:modelValue",d.value)}}function A(s){g.value.trim()!==""&&g.value&&(d.value.push(g.value),D("update:modelValue",d.value),g.value="")}return(s,o)=>(_(),V("label",{for:C.vid,class:"tab-input"},[e("div",Mt,[(_(!0),V(Z,null,tt(t(d),(S,R)=>(_(),V("div",{class:"m-1 inline-flex items-center rounded bg-theme-50 px-2 py-1 text-xs dark:bg-theme",key:R},[e("span",Rt,f(S),1),v(t($t),{class:"cursor-pointer hover:text-theme",size:12,title:"关闭",onClick:q=>z(R)},null,8,["onClick"])]))),128)),p(e("input",{placeholder:t(d).length?"":"请输入标签，回车添加",onKeydown:[H(A,["enter"]),o[0]||(o[0]=H(S=>z(),["delete"]))],"onUpdate:modelValue":o[1]||(o[1]=S=>et(g)?g.value=S:null),id:C.vid,ref_key:"tagInput",ref:r,type:"text",class:"no-style ml-2 inline-block bg-transparent outline-none"},null,40,jt),[[$,t(g)]])])],8,Nt))}};function Q(C){let D,u=C[0],r=1;for(;r<C.length;){const d=C[r],g=C[r+1];if(r+=2,(d==="optionalAccess"||d==="optionalCall")&&u==null)return;d==="access"||d==="optionalAccess"?(D=u,u=g(u)):(d==="call"||d==="optionalCall")&&(u=g((...z)=>u.call(D,...z)),D=void 0)}return u}const Ft={class:"page-knowledge_db_editor"},Lt=e("span",null,"创建知识库",-1),Pt={class:"button button-theme button-icon"},Ot={class:"button button-normal button-icon ml-4"},Jt=e("label",{class:"mb-2 block text-xl font-bold",for:"import-db"},"导入数据库",-1),Gt=e("div",{class:"mt-2 text-xs"},"仅支持本站导出的 .json 格式",-1),Ht={class:"mb-4 text-xl font-bold"},Xt={class:"mb-3 text-sm"},Qt=e("label",{for:"input-title",class:"mb-2 block"},"标题",-1),Wt={class:"mb-3 text-sm"},Yt=e("label",{for:"input-author",class:"mb-2 block"},"作者（选填）",-1),Zt={class:"mb-3 text-sm"},te=e("label",{for:"input-description",class:"mb-2 block"},"介绍（选填）",-1),ee={class:"mb-3 text-sm"},ne=e("label",{for:"input-tags",class:"mb-2 block"},"标签（选填）",-1),le=e("div",{class:"mb-4 block text-xl font-bold"},"添加知识",-1),oe=e("label",{for:"cinput-title",class:"mb-2 block"},"标题（选填）",-1),se=e("label",{for:"cinput-author",class:"mb-2 block"},"作者（选填）",-1),ae=e("label",{for:"cinput-content",class:"mb-2 block"},"内容",-1),re={class:"mb-4 block text-xl font-bold"},ie={class:"text-gray-400"},ue={class:"ml-1"},de={class:"flex flex-col justify-between rounded border p-4 ring-2 ring-theme ring-offset-transparent transition-all hover:border-transparent hover:bg-theme-50 hover:ring-offset-1 dark:border-slate-700 dark:hover:bg-theme-800 md:flex-row"},ce={class:"mr-0 flex flex-col md:mr-4 md:flex-row md:items-center"},me={class:"mr-2 line-clamp-1"},pe={class:"text-gray-400"},fe={class:"mr-2 mt-2 shrink-0 text-xs md:mt-0"},ve={class:"inline-block md:hidden"},he={class:"mt-2 hidden shrink-0 text-xs text-gray-500 md:mt-0 md:block"},ge={class:"mt-2 flex shrink-0 items-center justify-end text-xs md:mt-0"},be=["onClick"],_e=["onClick"],xe=e("span",{class:"mr-1"},"编辑",-1),ye={class:"mb-4 text-xl font-bold"},ke=e("span",null,"导出知识库",-1),we=e("span",null,"删除知识库",-1),De=e("div",{class:"mb-4 text-xl font-bold"},"如何使用：",-1),$e=e("p",null,"你可以在这里创建属于你自己的“百度”，每条数据作为一条知识，创建完毕后你可以快速对知识进行搜索",-1),Ie={class:"mb-6 leading-6"},Ce={class:"mb-5"},Ae=e("label",{for:"edit-data-dialog-title",class:"mb-2 block text-sm"},"标题（选填）",-1),Ve={class:"mb-5"},Be=e("label",{for:"edit-data-dialog-content",class:"mb-2 block text-sm"},"内容",-1),Te={class:"mb-5"},Ue=e("label",{for:"edit-data-dialog-author",class:"mb-2 block text-sm"},"作者（选填）",-1),Ee={class:"mb-6 flex items-center leading-6"},Xe=gt({__name:"editor",setup(C){const D=At("1234567890abcdefghijklmnopqrstuvwxyz",10);bt({title:"创建 AI 知识库"});const u=Ct(),{$toast:r}=_t(),d=xt(),g=yt(),z=w(!1),A=w(!0),s=w({title:"",description:"",tags:[],author:""}),o=w({key:null,value:null});function S(){o.value={key:null,value:null}}function R(){s.value={title:"",description:"",tags:[],author:""}}const q=w(null);async function P(a=!1){if(!u.$state.APIConfig.key)return r.error("请点击右上角配置 API Key");if(s.value.title.trim()===""){r.warning("请输入知识库标题");return}const n=a?o.value.key:`kdb-${D()}`;if(!n){r.warning("知识库不存在");return}let i;a?(i=await L(n),i.title=s.value.title,i.description=s.value.description,i.author=s.value.author,i.tags=Array.from(new Set(s.value.tags)),i.updatedAt=new Date().getTime()):i={version:1,id:n,title:s.value.title,author:s.value.author,description:s.value.description,tags:Array.from(new Set(s.value.tags)),content:[],createdAt:new Date().getTime(),lastUsedAt:new Date().getTime(),updatedAt:new Date().getTime(),createUser:u.$state.user.mail||"local"};try{await M(n,i)}catch{return a?r.error("更新失败，无法读取 indexedDB 数据库，请关闭隐身模式或更换浏览器"):r.error("创建失败，无法读取 indexedDB 数据库，请关闭隐身模式或更换浏览器")}a?r.success("更新成功，你可以在【我的知识库】中查看"):r.success("创建成功，你可以在【我的知识库】中查看"),z.value=!0,o.value={key:n,value:i},d.replace({query:{id:n}}),setTimeout(()=>{q.value.focus()},100)}const K=w(""),nt=kt(()=>K.value.trim()===""?o.value.value.content:o.value.value.content.filter(a=>a.title.includes(K.value)||a.content.includes(K.value))),c=w({title:"",content:"",author:""});function O(){c.value={title:"",content:"",author:""}}function lt(){R(),O(),S()}async function ot(){if(c.value.content.trim()===""){r.warning("请输入内容");return}u.$state.loading=!0;const a=o.value.key,n=await L(a);let i={data:[{embedding:[]}],usage:{prompt_tokens:0,total_tokens:0}};try{i=await u.apiEmbedding(`${c.value.title}
${c.value.content}`)}catch(k){return k instanceof Error?(u.$state.loading=!1,r.error(`创建失败：${k.message}`)):r.error(`创建失败：${k}`)}const[{embedding:x}]=i.data,y={id:D(),version:1,title:c.value.title,author:c.value.author,content:c.value.content,embedding:x,createdAt:new Date().getTime(),updatedAt:new Date().getTime(),usage:i.usage,createUser:u.$state.user.mail||"local",statistics:{view:0,like:0,dislike:0}};n.content.push(y);try{const k=o.value.key;await M(k,n)}catch{return r.error("创建失败，无法读取 indexedDB 数据库，请关闭隐身模式或更换浏览器")}r.success("添加数据成功，你可以在【我的知识库】中查看"),o.value.value=n,O(),u.$state.loading=!1}function st(a){if(!confirm("是否删除一条知识？"))return;const n=o.value.value;n.content=n.content.filter(x=>x.id!==a.id);const i=o.value.key;M(i,n).then(()=>{r.success("删除成功"),o.value.value=n})}const m=w({open:!1,editId:"",form:{title:"",content:"",author:""}});function J(){m.value={open:!1,editId:"",form:{title:"",content:"",author:""}}}async function at(){const a=o.value.value,n=a.content.findIndex(h=>h.id===m.value.editId);if(n===-1)return r.error("更新失败，未找到对应的知识");const i=a.content[n];if(i.title===m.value.form.title&&i.content===m.value.form.content){if(m.value.form.author!==i.author){i.author=m.value.form.author,i.updatedAt=new Date().getTime();const h=o.value.key;M(h,X(a)).then(()=>{r.success("更新成功"),o.value.value=a,J()}).catch(()=>{r.error("更新失败，无法读取 indexedDB 数据库，请关闭隐身模式或更换浏览器")});return}return r.success("更新成功")}u.$state.loading=!0;let x;try{x=await u.apiEmbedding(`${m.value.form.title}
${m.value.form.content}`)}catch(h){return h instanceof Error?(u.$state.loading=!1,r.error(`更新失败，无法获取向量数据：${h.message}`)):r.error(`更新失败，无法获取向量数据：${h}`)}const[{embedding:y}]=x.data;a.content[n]={...a.content[n],...m.value.form,embedding:y,updatedAt:new Date().getTime()};const k=o.value.key;M(k,X(a)).then(()=>{u.$state.loading=!1,J(),r.success("更新成功"),o.value.value=a,m.value.open=!1}).catch(()=>{u.$state.loading=!1,r.error("更新失败，无法读取 indexedDB 数据库，请关闭隐身模式或更换浏览器")})}function rt(a){m.value.open=!0,m.value.editId=a.id,m.value.form={title:a.title,content:a.content,author:a.author}}function G(){let{id:a}=g.query;a?L(a).then(n=>{if(!n)return d.replace("/knowledge_db/editor"),r.error(`无法读取知识库，请检查知识库【${a}】是否存在`);o.value={key:a,value:n},s.value.title=n.title,s.value.author=n.author,s.value.description=n.description,s.value.tags=n.tags}):lt()}Y(()=>g.query,()=>{G()}),wt(()=>{G()});async function it(a){const n=a.target.files;if(n&&n.length>0){const i=n[0],x=new FileReader;x.onload=async y=>{const k=y.target.result;let h;try{if(h=JSON.parse(k),!h.title||!h.description||!h.tags||!h.content)return r.error("导入失败，该数据库可能已经损坏")}catch(B){if(B instanceof Error)return r.error(`导入失败，该数据库可能已经损坏：${B.message}`)}const l=`kdb_${D()}`,j=h;try{await M(l,j)}catch(B){if(B instanceof Error)return r.error(`导入失败：${B.message}`)}r.success("导入成功，你可以在【我的知识库】中查看"),d.replace({query:{id:l}})},x.readAsArrayBuffer(i)}}function ut(a){const n=/[\[\]{}()*+?.,\\^$|#\s]/g;return a.replace(n,"")}function dt(){if(confirm(`确定要导出知识库【${o.value.value.title}】吗？`)===!1)return;const a="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(o.value.value)),n=document.createElement("a");n.setAttribute("href",a),n.setAttribute("download",`${ut(o.value.value.title)}.json`),document.body.appendChild(n),n.click(),n.remove(),r.success("导出成功")}const F=w({open:!1});function ct(){const a=o.value.key;Dt(a).then(()=>{r.success("删除成功"),d.replace("/knowledge_db")}).catch(n=>{r.error(`删除失败：${n.message}`)})}return(a,n)=>{const i=mt,x=pt,y=ht,k=qt,h=It;return _(),V("div",Ft,[v(x,{shadow:"",fixed:""},{"nav-left":b(()=>[p(v(i,{to:"/knowledge_db",class:"nav-item",title:"返回知识库"},{default:b(()=>[v(t(Vt))]),_:1},512),[[I,a.$route.path!=="/"]])]),"nav-center":b(()=>[v(t(Bt)),Lt]),_:1}),e("main",null,[t(o).key?(_(),N(y,{key:0,class:"import-db"},{default:b(()=>[t(o).value.content.length?(_(),N(i,{key:0,to:`/chat?type=kdb&kdb=${t(o).key}`},{default:b(()=>[e("button",Pt,[v(t(Tt),{size:16,class:"mr-1"}),U("使用数据库【"+f(t(o).value.title)+"】开始聊天 ",1)])]),_:1},8,["to"])):T("",!0),v(i,{to:"/knowledge_db/editor"},{default:b(()=>[e("button",Ot,[v(t(Ut),{size:16,class:"mr-1 text-gray-500"}),U("创建新的数据库")])]),_:1})]),_:1})):T("",!0),t(o).key?T("",!0):(_(),N(y,{key:1,class:"import-db"},{default:b(()=>[Jt,e("input",{onChange:it,class:"","aria-describedby":"upload_file",id:"import-db",type:"file",accept:".json",ref:"fileInput"},null,544),Gt]),_:1})),v(y,null,{default:b(()=>[e("div",Ht,f(t(o).key?`编辑知识库：${t(o).value.title}`:"创建知识库："),1),e("div",null,[e("div",Xt,[Qt,p(e("input",{"onUpdate:modelValue":n[0]||(n[0]=l=>t(s).title=l),id:"input-title",class:"w-full",type:"text",placeholder:"例如：🦠新冠防护手册"},null,512),[[$,t(s).title]]),p(e("div",{class:E(["mt-2 text-right text-xs",{"text-red-500":t(s).title.length>50}])}," 字数："+f(t(s).title.length)+" / 50 ",3),[[I,t(s).title.length>30]])]),e("div",Wt,[Yt,p(e("input",{"onUpdate:modelValue":n[1]||(n[1]=l=>t(s).author=l),id:"input-author",class:"w-full",type:"text",placeholder:"例如：张三"},null,512),[[$,t(s).author]]),p(e("div",{class:E(["mt-2 text-right text-xs",{"text-red-500":t(s).author.length>50}])}," 字数："+f(t(s).author.length)+" / 50 ",3),[[I,t(s).author.length>30]])]),e("div",Zt,[te,p(e("textarea",{"onUpdate:modelValue":n[2]||(n[2]=l=>t(s).description=l),id:"input-description",class:"w-full resize-none",rows:"5",placeholder:"例如：本手册有助于全球公众对新型冠状病毒肺炎及其防控知识的了解"},null,512),[[$,t(s).description]]),p(e("div",{class:E(["mt-2 text-right text-xs",{"text-red-500":t(s).description.length>200}])}," 字数："+f(t(s).description.length)+" / 200 ",3),[[I,t(s).description.length>150]])]),e("div",ee,[ne,v(k,{vid:"input-tags",modelValue:t(s).tags,"onUpdate:modelValue":n[3]||(n[3]=l=>t(s).tags=l)},null,8,["modelValue"]),p(e("div",{class:E(["mt-2 text-right text-xs",{"text-red-500":t(s).tags.length>20}])}," 标签数："+f(t(s).tags.length)+" / 20 ",3),[[I,t(s).tags.length>10]])])]),t(o).key?(_(),V("button",{key:0,class:"button button-theme mt-1",onClick:n[4]||(n[4]=l=>P(!0))},"更新知识库")):(_(),V("button",{key:1,class:"button button-theme mt-1",onClick:n[5]||(n[5]=l=>P(!1))},"完成创建"))]),_:1}),t(o).key?(_(),N(y,{key:2},{default:b(()=>[le,e("div",null,[oe,p(e("input",{ref_key:"addDataTitleInput",ref:q,id:"cinput-title","onUpdate:modelValue":n[6]||(n[6]=l=>t(c).title=l),class:"mb-4 w-full",type:"text",placeholder:"例如：疫情期间如何正确收取快递？"},null,512),[[$,t(c).title]]),p(e("div",{class:E(["mt-2 text-right text-xs",{"text-red-500":t(c).title.length>50}])}," 字数："+f(t(c).title.length)+" / 50 ",3),[[I,t(c).title.length>30]])]),e("div",null,[se,p(e("input",{id:"cinput-author","onUpdate:modelValue":n[7]||(n[7]=l=>t(c).author=l),class:"mb-4 w-full",type:"text",placeholder:"例如：疫情期间如何正确收取快递？"},null,512),[[$,t(c).author]]),p(e("div",{class:E(["mt-2 text-right text-xs",{"text-red-500":t(c).author.length>50}])}," 字数："+f(t(c).author.length)+" / 50 ",3),[[I,t(c).author.length>30]])]),e("div",null,[ae,p(e("textarea",{id:"cinput-content","onUpdate:modelValue":n[8]||(n[8]=l=>t(c).content=l),class:"mb-4 block w-full resize-none",rows:"5",placeholder:"例如：有条件的情况下，最好请快递员将物品存放在快递柜中。取件人在家里、小区门口或快递柜取件时，均需佩戴好口罩和手套，避免人员聚集。处理完包裹后要及时摘下手套，并用流水洗手或使用手消毒剂。快递外包装按照生活垃圾分类要求及时妥善处理。"},null,512),[[$,t(c).content]]),p(e("div",{class:E(["mt-2 text-right text-xs",{"text-red-500":t(c).content.length>5e3}])}," 字数："+f(t(c).content.length)+" / 5000 ",3),[[I,t(c).content.length>4e3]])]),e("div",null,[e("button",{class:"button button-theme",onClick:ot},"添加一条")])]),_:1})):T("",!0),t(o).key&&t(o).value.content.length?(_(),N(y,{key:3},{default:b(()=>[e("div",re,[U(" 管理知识 "),e("span",ie,"- 共 "+f(t(o).value.content.length)+" 条",1)]),p(e("input",{"onUpdate:modelValue":n[9]||(n[9]=l=>et(K)?K.value=l:null),class:"mb-4 w-full",type:"text",placeholder:"搜索标题/内容/标签"},null,512),[[$,t(K)]]),e("div",{onClick:n[10]||(n[10]=l=>A.value=!t(A)),class:"mb-4 inline-flex cursor-pointer items-center text-xs hover:text-theme"},[p(v(t(ft),{size:16},null,512),[[I,!t(A)]]),p(v(t(vt),{size:16},null,512),[[I,t(A)]]),e("span",ue,f(t(A)?"折叠全部":"展开全部"),1)]),t(A)?(_(!0),V(Z,{key:0},tt(t(nt),(l,j)=>(_(),V("div",{class:"mb-6 last:mb-0",key:j},[e("div",de,[e("div",ce,[e("b",me,[e("span",pe,f(j+1)+".",1),U(" "+f(l.title||l.content),1)]),e("div",fe,[U(f(l.content.length)+" 个字 ",1),e("span",ve,"/ "+f(new Date(l.updatedAt).toLocaleString()),1)]),e("div",he,f(new Date(l.updatedAt).toLocaleString()),1)]),e("div",ge,[e("div",{class:"mr-3 cursor-pointer hover:text-theme",onClick:B=>st(l)},"删除",8,be),e("div",{class:"group flex cursor-pointer items-center hover:text-theme",onClick:B=>rt(l)},[xe,v(t(Kt),{size:14,class:"text-gray-500 group-hover:text-theme"})],8,_e)])])]))),128)):T("",!0)]),_:1})):T("",!0),t(o).key?(_(),N(y,{key:4},{default:b(()=>[e("div",ye,"知识库设置："+f(t(o).value.title),1),e("button",{onClick:dt,class:"button button-normal button-icon mr-2",title:"导出数据为 JSON"},[v(t(Et),{size:16,class:"mr-1"}),ke]),e("button",{onClick:n[11]||(n[11]=l=>t(F).open=!0),class:"button button-normal button-icon",title:"删除知识库"},[v(t(zt),{size:16,class:"mr-1"}),we])]),_:1})):T("",!0),v(y,null,{default:b(()=>[De,$e]),_:1})]),v(h,{visible:t(m).open,"onUpdate:visible":n[15]||(n[15]=l=>t(m).open=l),title:"编辑知识",cancelButtonText:"取消",confirmButtonText:"保存",onConfirm:at,size:"xl"},{content:b(()=>[e("div",Ie,[e("div",Ce,[Ae,p(e("input",{id:"edit-data-dialog-title","onUpdate:modelValue":n[12]||(n[12]=l=>t(m).form.title=l),placeholder:"知识标题",class:"w-full"},null,512),[[$,t(m).form.title,void 0,{trim:!0}]])]),e("div",Ve,[Be,p(e("textarea",{id:"edit-data-dialog-content","onUpdate:modelValue":n[13]||(n[13]=l=>t(m).form.content=l),placeholder:"知识内容",class:"w-full",rows:"7"},null,512),[[$,t(m).form.content,void 0,{trim:!0}]])]),e("div",Te,[Ue,p(e("input",{id:"edit-data-dialog-author","onUpdate:modelValue":n[14]||(n[14]=l=>t(m).form.author=l),placeholder:"作者",class:"w-full"},null,512),[[$,t(m).form.author,void 0,{trim:!0}]])])])]),_:1},8,["visible"]),v(h,{visible:t(F).open,"onUpdate:visible":n[16]||(n[16]=l=>t(F).open=l),title:`删除知识库：${Q([t,"call",l=>l(o),"access",l=>l.value,"optionalAccess",l=>l.title])}`,cancelButtonText:"取消",confirmButtonText:"删除",onConfirm:ct},{content:b(()=>[e("p",Ee,[v(t(St),{size:36,class:"mr-4 text-red-500"}),e("span",null,[U("此操作不可逆，是否删除数据库【"),e("b",null,f(Q([t,"call",l=>l(o),"access",l=>l.value,"optionalAccess",l=>l.title])),1),U("】。")])])]),_:1},8,["visible","title"])])}}});export{Xe as default};
