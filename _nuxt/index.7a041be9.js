import{c as W,_ as ie}from"./Navbar.0f0e4624.js";import{_ as ce}from"./Container.856f971b.js";import{_ as de}from"./nuxt-link.60028201.js";import{_ as ue}from"./Dialog.876fc127.js";import{u as me}from"./index.b7543822.js";import{a as _e,q as pe,s as h,x as K,a0 as fe,y as ve,k as he,o as d,b as u,f as y,i as b,e as t,u as o,c as ye,A as g,O as U,N as z,B as P,D as V,G as E,C as xe,t as m,F as H,r as j,h as ke,P as M,a1 as be,a2 as ge,a3 as we}from"./entry.b980ff2a.js";import{c as G}from"./confetti.module.249a7e39.js";import{I as $e}from"./IconDatabaseExport.8599c1bd.js";import{I as Ce}from"./IconTrash.149de794.js";import"./LoadingSvg.54a92436.js";var Ie=W("database-import","IconDatabaseImport",[["path",{d:"M4 6c0 1.657 3.582 3 8 3s8 -1.343 8 -3s-3.582 -3 -8 -3s-8 1.343 -8 3",key:"svg-0"}],["path",{d:"M4 6v6c0 1.657 3.582 3 8 3c.856 0 1.68 -.05 2.454 -.144m5.546 -2.856v-6",key:"svg-1"}],["path",{d:"M4 12v6c0 1.657 3.582 3 8 3c.171 0 .341 -.002 .51 -.006",key:"svg-2"}],["path",{d:"M19 22v-6",key:"svg-3"}],["path",{d:"M22 19l-3 -3l-3 3",key:"svg-4"}]]),Ne=W("user-heart","IconUserHeart",[["path",{d:"M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0",key:"svg-0"}],["path",{d:"M6 21v-2a4 4 0 0 1 4 -4h.5",key:"svg-1"}],["path",{d:"M18 22l3.35 -3.284a2.143 2.143 0 0 0 .005 -3.071a2.242 2.242 0 0 0 -3.129 -.006l-.224 .22l-.223 -.22a2.242 2.242 0 0 0 -3.128 -.006a2.143 2.143 0 0 0 -.006 3.071l3.355 3.296z",key:"svg-2"}]]);const Z=""+new URL("alipay.cbb10969.svg",import.meta.url).href,B=""+new URL("wxpay.04b0ec25.svg",import.meta.url).href;function De(C){let n,l=C[0],i=1;for(;i<C.length;){const _=C[i],p=C[i+1];if(i+=2,(_==="optionalAccess"||_==="optionalCall")&&l==null)return;_==="access"||_==="optionalAccess"?(n=l,l=p(l)):(_==="call"||_==="optionalCall")&&(l=p((...x)=>l.call(n,...x)),n=void 0)}return l}const Te={class:"page-user"},Me=t("span",null,"密钥管理",-1),Ae={class:"mb-6"},Se=t("div",{class:"mb-2 flex items-center text-lg font-bold"},"密钥：",-1),Oe={class:"flex"},Ke={key:0,class:"mt-2 flex items-center text-xs text-gray-500"},Pe={key:0,class:"mb-6"},Be={class:"mb-2 text-lg font-bold"},qe={key:0,class:"-m-2"},Fe=["onClick"],Re={class:""},Je={class:"font-bold"},Le={class:"product-item-price"},Ue={class:"product-item-desc"},ze={key:1,class:"skeleton"},Ve=t("div",{class:"skeleton-item"},null,-1),Ee=t("div",{class:"skeleton-item hidden md:block"},null,-1),He=t("div",{class:"skeleton-item hidden md:block"},null,-1),je=[Ve,Ee,He],Ge={key:2,class:"mt-4"},We=t("img",{class:"mr-2 block w-5",src:Z,alt:""},null,-1),Ze=t("span",null,"支付宝",-1),Qe=[We,Ze],Xe=t("img",{class:"mr-2 block w-5",src:Z,alt:""},null,-1),Ye=t("span",null,"支付宝",-1),et=[Xe,Ye],tt=t("img",{class:"mr-2 block w-5",src:B,alt:""},null,-1),st=t("span",null,"微信",-1),ot=[tt,st],at=t("img",{class:"mr-2 block w-5",src:B,alt:""},null,-1),nt=t("span",null,"微信",-1),lt=[at,nt],rt=t("hr",{class:"mb-6"},null,-1),it={class:"mb-6"},ct=t("div",{class:"mb-2 text-lg font-bold"},"其他：",-1),dt={class:"-m-2"},ut={for:"import-data",class:"button button-normal m-2 inline-flex items-center"},mt=t("span",{class:"ml-2"},"导入数据",-1),_t=t("span",{class:"ml-2"},"导出数据",-1),pt=t("span",{class:"ml-2"},"清空数据",-1),ft=t("div",{class:"mb-2 text-lg font-bold"},"订单记录",-1),vt=t("div",{class:"mb-4 text-sm text-gray-500"},"支付成功后请点击最右侧“刷新”按钮检查订单",-1),ht={class:"prose max-w-none overflow-x-auto dark:prose-invert"},yt={class:"w-full min-w-max"},xt=t("thead",null,[t("tr",null,[t("th",null,"订单号"),t("th",null,"产品"),t("th",null,"金额"),t("th",null,"状态"),t("th",null,"创建时间"),t("th",null,"操作")])],-1),kt=["onClick"],bt=["onClick"],gt=t("div",{class:"mb-2 text-lg font-bold"},"忘记密钥",-1),wt=t("div",{class:"mb-4 text-sm text-gray-500"}," 如果你忘记了密钥，可以在这里找回，格式为：ct_t10k_xxxxxxxxxx_wxpc，你可在支付宝或微信账单中查看订单号 ",-1),$t={class:"flex"},Ct={key:0,class:"mt-2 text-red-500"},It=t("div",{class:"mb-4 text-xl font-bold"},"说明",-1),Nt={class:"leading-8"},Dt=t("p",null,"如有其他问题请联系邮箱：imiku.me@gmail.com 或微信 lovesnad",-1),Tt=t("div",{class:"pay-wait-dialog mb-6 leading-8"},[t("p",null,"请在新页面中进行支付，订单将在 5 分钟后自动关闭。"),t("p",null,"如遇到问题无法支付，请联系微信：lovesnad 进行支付")],-1),Mt={class:"pay-dialog mb-6 leading-6"},At={class:"mb-2 text-center"},St={class:"text-2xl"},Ot={class:"relative flex items-center justify-center"},Kt={class:"rounded border border-gray-300 bg-white dark:border-gray-600"},Pt=["src"],Bt={key:0,class:"absolute w-7 rounded border border-gray-300 bg-white p-0.5",src:B,alt:""},qt={class:"mt-4 text-gray-500 dark:text-inherit"},Ft=t("div",{class:"text-center text-sm"},"请使用微信扫一扫支付",-1),Rt={class:"mt-2 text-center text-xs"},Jt={class:"text-theme dark:text-white"},Qt=_e({__name:"index",setup(C){const n=me(),{$toast:l}=pe(),i=h(""),_=h([]),p=h(null),x=h([]),q=h(n.$state.isMobile?"aliwap":"alipc"),c=h({open:!1,qrcode:"",orderId:"",orderNo:"",timer:null,timeout:5*60*1e3,closeTime:0,closeTimer:""}),f=h({open:!1,data:null}),F=K(()=>n.$state.APIConfig.key),Q=/^(sk|cat)-([0-9A-Za-z]{48})$/,A=K(()=>/^(cat)-[0-9A-Za-z]{48}$/.test(i.value)),X=K(()=>Q.test(i.value)||i.value==="");let w=h(null);async function Y(){if(!X.value)return l.error("密钥格式错误"),!1;if(i.value===F.value)return l.success("密钥未修改"),!1;if(i.value==="")return n.$state.APIConfig.key="",l.success("密钥已清空"),!1;n.$state.loading=!0;try{const s=await n.apiCheckKey(i.value);w.value={key:i.value,token_count:s.data.data.token_count},n.$state.loading=!1,l.success("密钥验证成功"),n.$state.APIConfig.key=i.value}catch(s){if(s.response){const e=s.response.status;e===401?l.error(`密钥错误，请重新输入：${s}，状态码：${e}`):l.error(`出现错误，请检查密钥和网络：${s}，状态码：${e}`)}else l.error(`出现错误，请检查网络设置：${s.message}`);return n.$state.loading=!1,!1}}function ee(){const s=Date.now()+1e3,e=["#FA5477","#249FFD"];function r(){G({particleCount:2,angle:60,spread:55,origin:{x:0},colors:e}),G({particleCount:2,angle:120,spread:55,origin:{x:1},colors:e}),Date.now()<s&&requestAnimationFrame(r)}r()}function te(s){prompt("密钥",s.key)}function I(s){q.value=s,n.$state.loading=!0,n.apiPayCreateOrder(p.value._id,s,i.value).then(async e=>{n.$state.loading=!1,s==="wxpc"?se(e):s==="wxwap"?oe(e):(s==="alipc"||s==="aliwap")&&J(e),x.value.unshift({orderId:e.orderId,orderNo:e.orderNo,productName:p.value.name,price:p.value.price,status:!1,createTime:new Date}),await U("order",z(x.value))}).catch(e=>{let r=e.message;e.response&&e.response._data&&e.response._data.error&&(r=e.response._data.error.message),n.$state.loading=!1,l.error(`提交订单失败：${JSON.stringify(r)}`)})}function se(s){c.value.orderId=s.orderId,c.value.orderNo=s.orderNo,c.value.open=!0,c.value.qrcode=s.data,c.value.closeTimer="05:00",c.value.closeTime=Date.now()+c.value.timeout,c.value.timer=setInterval(()=>{const e=Date.now();e>=c.value.closeTime&&N(s.orderNo),c.value.closeTimer=new Date(c.value.closeTime-e).toISOString().substr(14,5)},1e3)}function oe(s){setTimeout(async()=>{window.open(`${n.$state.env.pay_redirect_url}?url=${encodeURIComponent(s.data)}`,"_top")}),f.value.open=!0,f.value.data=s}const R=h(null);function J(s){const e=R.value;e.innerHTML=s.data;const r=e.querySelector("form");r.target="_self",r.submit(),setTimeout(()=>{e.innerHTML=""},100),f.value.open=!0,f.value.data=s}function S(s){n.$state.loading=!0,n.apiPayCheckOrder(s||f.value.data.orderNo).then(async e=>{n.$state.loading=!1,e.status?(s&&(x.value.forEach(r=>{r.orderNo===s&&(r.status=e.status,r.key=e.data.key)}),await U("order",z(x.value))),l.success("支付成功，请妥善保管好你的 Key"),n.$state.APIConfig.key=e.data.key,i.value=e.data.key,c.value.open=!1,f.value.open=!1,c.value.timer&&clearInterval(c.value.timer),ee()):l.error("支付失败或未支付")}).catch(e=>{let r=e.message;e.response&&e.response._data&&e.response._data.error&&(r=e.response._data.error.message),n.$state.loading=!1,l.error(`订单检查失败：${JSON.stringify(r)}`)})}function N(s){c.value.open=!1,f.value.open=!1,s&&n.apiPayCloseOrder(s),c.value.timer&&clearInterval(c.value.timer)}fe(()=>{N()});async function ae(){if(confirm("确定要导出所有数据吗？")===!1)return;let s;try{s=await be()}catch(T){return l.error(`导出失败：${T}`)}const e={version:1,date:new Date().toISOString(),data:s},r="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),k="CatGPT-"+new Date().toISOString().replace(/:/g,"-")+".json",v=document.createElement("a");v.setAttribute("href",r),v.setAttribute("download",k),document.body.appendChild(v),v.click(),v.remove(),l.success("导出成功")}async function ne(s){const e=s.target.files[0];if(!e)return;const r=new FileReader;r.onload=async k=>{try{const v=JSON.parse(k.target.result);if(v.version!==1)return l.error("导入失败：不支持的数据格式");if(confirm("如有相同的数据将被覆盖，确定要导入吗？")===!1)return;await ge(v.data)}catch{l.error("导入失败：数据损坏或不支持的数据格式")}},r.readAsText(e)}async function le(){if(confirm("此操作不可逆，确定要清空所有数据吗？")!==!1)try{await we(),localStorage.clear(),l.success("清空成功")}catch(s){l.error(`清空失败：${s}`)}}ve(async()=>{try{await he("order").then(s=>{s&&(x.value=s)})}catch(s){l.error(`获取订单列表失败，无法读取 indexedDB 数据库，请关闭隐身模式或更换浏览器：${s}`)}if(i.value=n.$state.APIConfig.key,A.value)try{const s=await n.apiCheckKey(i.value);w.value={key:i.value,token_count:s.data.data.token_count}}catch(s){let e=s;s.response&&s.response._data&&(e=s.response._data.error.message),l.error(`获取密钥额度失败：
${e}`)}n.apiPayGetProducts().then(s=>{_.value=s.data,p.value=s.data[0]}).catch(s=>{let e=s;s.response&&s.response._data&&(e=s.response._data.error.message),l.error(`获取商品列表失败：
${e}`)})});const $=h(""),D=h("");function re(){if(!$.value)return l.error("请输入密钥");if(/^ct_(\w+)_(\w{10})_(\w+)$/.test($.value.trim())===!1)return l.error("密钥格式错误");n.$state.loading=!0,D.value="",n.apiPayCheckOrder($.value.trim()).then(s=>{prompt("绑定的密钥为：",s.data.key),D.value=s.data.key,n.$state.loading=!1}).catch(s=>{let e=s;s.response&&s.response._data&&(e=s.response._data.error.message),l.error(`查询密钥失败：
${e}`),n.$state.loading=!1})}return(s,e)=>{const r=ie,k=ce,v=de,T=ue;return d(),u("div",Te,[y(r,{shadow:"",fixed:""},{"nav-center":b(()=>[y(o(Ne)),Me]),_:1}),t("main",null,[y(k,null,{default:b(()=>[t("div",Ae,[Se,t("div",Oe,[P(t("input",{class:"w-full shrink",type:"text",placeholder:"sk-xxxxxx 或 cat-xxxxxx","onUpdate:modelValue":e[0]||(e[0]=a=>E(i)?i.value=a:null)},null,512),[[V,o(i),void 0,{trim:!0}]]),P(t("button",{onClick:Y,class:"button button-theme ml-2 shrink-0"},"保存密钥",512),[[xe,o(F)!==o(i)]])]),o(w)&&o(w).key===o(i)?(d(),u("div",Ke,[t("div",null,"密钥额度："+m(o(w).token_count<=0?"密钥额度不足":`${o(w).token_count} tokens`),1)])):g("",!0)]),o(A)||!o(i)?(d(),u("div",Pe,[t("div",Be,m(o(A)?"充值：":"购买密钥"),1),o(_).length?(d(),u("div",qe,[(d(!0),u(H,null,j(o(_),(a,O)=>(d(),u("div",{onClick:L=>p.value=a,class:ke([{"product-item-active":a.key===o(p).key},"product-item"]),key:O},[t("div",Re,[t("span",Je,m(a.name),1),t("span",Le,"/ ￥"+m(a.price),1)]),t("div",Ue,m(a.description),1)],10,Fe))),128))])):(d(),u("div",ze,je)),o(_).length?(d(),u("div",Ge,[o(n).$state.isMobile?(d(),u("button",{key:1,onClick:e[2]||(e[2]=a=>I("aliwap")),title:"支付宝支付",class:"button button-normal mr-4 inline-flex items-center"},et)):(d(),u("button",{key:0,onClick:e[1]||(e[1]=a=>I("alipc")),title:"支付宝支付",class:"button button-normal mr-4 inline-flex items-center"},Qe)),o(n).$state.isMobile?(d(),u("button",{key:3,onClick:e[4]||(e[4]=a=>I("wxwap")),title:"微信支付",class:"button button-normal inline-flex items-center"},lt)):(d(),u("button",{key:2,onClick:e[3]||(e[3]=a=>I("wxpc")),title:"微信扫码",class:"button button-normal inline-flex items-center"},ot))])):g("",!0)])):g("",!0),rt,t("div",it,[ct,t("div",dt,[t("label",ut,[y(o(Ie),{size:14}),mt,t("input",{class:"hidden",type:"file",id:"import-data",onChange:ne,accept:".json"},null,32)]),t("button",{onClick:ae,class:"button button-normal m-2 inline-flex items-center"},[y(o($e),{size:14}),_t]),t("button",{onClick:le,class:"button button-normal m-2 inline-flex items-center"},[y(o(Ce),{size:14}),pt])])])]),_:1}),o(x).length?(d(),ye(k,{key:0},{default:b(()=>[ft,vt,t("div",ht,[t("table",yt,[xt,t("tbody",null,[(d(!0),u(H,null,j(o(x),(a,O)=>(d(),u("tr",{key:O},[t("td",null,m(a.orderNo),1),t("td",null,m(a.productName),1),t("td",null,m(a.price),1),t("td",null,m(a.status?"已支付":"未完成"),1),t("td",null,m(new Date(a.createTime).toLocaleString()),1),t("td",null,[a.status?g("",!0):(d(),u("button",{key:0,onClick:L=>S(a.orderNo),class:"button button-normal"},"刷新",8,kt)),a.status?(d(),u("button",{key:1,onClick:L=>te(a),class:"button button-theme"},"密钥",8,bt)):g("",!0)])]))),128))])])])]),_:1})):g("",!0),y(k,null,{default:b(()=>[gt,wt,t("div",$t,[P(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>E($)?$.value=a:null),class:"flex-grow",type:"text",placeholder:"请输入购买后的订单号"},null,512),[[V,o($)]]),t("button",{onClick:re,class:"button button-theme ml-2"},"点击查询")]),o(D)?(d(),u("div",Ct,"查询结果："+m(o(D)),1)):g("",!0)]),_:1}),y(k,null,{default:b(()=>[It,t("div",Nt,[t("p",null,[M("如果你没有自己的 Key，购买前请先查看 "),y(v,{class:"text-theme",to:"/qa"},{default:b(()=>[M("帮助文档")]),_:1})]),Dt])]),_:1})]),t("div",{ref_key:"alipayForm",ref:R,class:"alipay-form"},null,512),y(T,{visible:o(f).open,"onUpdate:visible":e[6]||(e[6]=a=>o(f).open=a),title:"提示",cancelButtonText:"取消支付",confirmButtonText:"支付成功",size:"md",onConfirm:e[7]||(e[7]=a=>S(o(f).data.orderNo)),onCancel:e[8]||(e[8]=a=>N(o(f).data.orderNo))},{content:b(()=>[Tt]),_:1},8,["visible"]),y(T,{visible:o(c).open,"onUpdate:visible":e[9]||(e[9]=a=>o(c).open=a),title:"购买："+De([o,"call",a=>a(p),"optionalAccess",a=>a.name]),cancelButtonText:"取消支付",confirmButtonText:"支付成功",size:"md",onConfirm:e[10]||(e[10]=a=>S(o(c).orderNo)),onCancel:e[11]||(e[11]=a=>N(o(c).orderNo))},{content:b(()=>[t("div",Mt,[t("div",At,[t("div",St,"￥"+m(o(p).price.toFixed(2)),1)]),t("div",Ot,[t("div",Kt,[t("img",{class:"pay-dialog-qrcode mx-auto block h-36 w-36",src:o(c).qrcode,alt:"qrcode",title:"支付二维码"},null,8,Pt)]),o(q)==="wxpc"?(d(),u("img",Bt)):g("",!0)]),t("div",qt,[Ft,t("div",Rt,[M(" 订单将在 "),t("span",Jt,m(o(c).closeTimer),1),M(" 后关闭 ")])])])]),_:1},8,["visible","title"])])}}});export{Qt as default};
